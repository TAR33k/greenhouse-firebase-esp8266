<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Greenhouse Monitor</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Variables */
    :root {
      --primary-color: #2ecc71;
      --secondary-color: #27ae60;
      --accent-color: #e74c3c;
      --bg-color: #f8f9fa;
      --text-color: #2c3e50;
      --card-bg: #ffffff;
      --border-color: #ddd;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }

    [data-theme="dark"] {
      --bg-color: #1a1a1a;
      --text-color: #ffffff;
      --card-bg: #2d2d2d;
      --border-color: #404040;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

    /* Base Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }

    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      transition: var(--transition);
      min-height: 100vh;
    }

    /* Layout */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    .dashboard {
      display: grid;
      gap: 2rem;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 1.5rem;
      box-shadow: var(--shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .logo i {
      font-size: 2rem;
    }

    .theme-language {
      display: flex;
      gap: 1rem;
    }

    /* Sensor Cards */
    .sensor-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
    }

    .sensor-card {
      background: var(--card-bg);
      border-radius: 15px;
      padding: 1.5rem;
      box-shadow: var(--shadow);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      z-index: 2;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .sensor-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: var(--primary-color);
    }

    .sensor-card:hover {
      transform: translateY(-5px);
    }

    .sensor-card i {
      font-size: 2rem;
      color: var(--primary-color);
      margin-bottom: 1rem;
      padding-top: 24px;
    }

    .sensor-value {
      font-size: 2rem;
      font-weight: 600;
      margin: 1rem 0;
    }

    .status-indicator {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: inline-block;
      margin-left: 0.5rem;
    }

    /* Water Card Specific Styles */
    #waterCard {
      position: relative;
      overflow: hidden;
      border: none;
      background: var(--card-bg);
      min-height: 200px;
    }

    #waterCard::before {
      display: none;
    }

    #waterCard .water-content {
      position: relative;
      z-index: 2;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1.5rem;
    }

    .water-content i {
      padding-top: 0;
    }

    #waterCard .water-fill {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      background: linear-gradient(to bottom, #3498db80, #2980b9);
      transition: height 0.5s ease-out;
      z-index: 1;
    }

    #waterCard .water-lines {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: repeating-linear-gradient(
              to top,
              transparent,
              transparent 20%,
              rgba(255, 255, 255, 0.1) 20%,
              rgba(255, 255, 255, 0.1) 21%
      );
      z-index: 1;
    }

    #waterCard::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(
              90deg,
              rgba(255, 255, 255, 0.1),
              transparent 20%,
              transparent 80%,
              rgba(255, 255, 255, 0.1)
      );
      border: 3px solid var(--primary-color);
      border-radius: 15px;
      z-index: 3;
      pointer-events: none;
    }

    /* Graphs Section */
    .graphs-container {
      background: var(--card-bg);
      border-radius: 15px;
      padding: 1.5rem;
      box-shadow: var(--shadow);
      position: relative;
      width: 100%;
    }

    .graph-controls {
      display: flex;
      justify-content: space-between;
      margin-bottom: 1rem;
    }

    .graphs {
      display: grid;
      gap: 2rem;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    }

    .graphs canvas {
      width: 100% !important;
      height: 100% !important;
      max-height: 400px;
    }

    /* Configuration Section */
    .config-section {
      background: var(--card-bg);
      border-radius: 15px;
      padding: 1.5rem;
      box-shadow: var(--shadow);
    }

    .config-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    /* Form Elements */
    button {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 5px;
      cursor: pointer;
      transition: var(--transition);
      height: 3rem;
    }

    button:hover {
      background: var(--secondary-color);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    select, input[type="text"], input[type="date"] {
      padding: 0.5rem;
      border-radius: 5px;
      border: 1px solid var(--border-color);
      background: var(--card-bg);
      color: var(--text-color);
    }

    .config-grid input[type="number"] {
      width: 80%;
      padding: 0.5rem;
      border: 1px solid var(--border-color);
      border-radius: 5px;
      background: var(--card-bg);
      color: var(--text-color);
    }

    .config-grid input[type="checkbox"] {
      width: 30px;
      height: 30px;
      margin-top: 0.5rem;
    }

    /* History Section */
    .history-section {
      background: var(--card-bg);
      border-radius: 15px;
      padding: 1.5rem;
      box-shadow: var(--shadow);
    }

    .history-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin: 1rem 0;
      align-items: center;
    }

    .filters {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .pagination {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .page-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* Table Styles */
    .table-container {
      max-height: 400px;
      overflow-y: auto;
      margin-top: 1rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }

    th {
      background: var(--primary-color);
      color: white;
      position: sticky;
      top: 0;
    }

    .toggle-switch, .pump-controls {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .switch-container {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 34px;
    }

    .switch-container input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 34px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 26px;
      width: 26px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: var(--primary-color);
    }

    input:disabled + .slider {
      opacity: 0.5;
      cursor: not-allowed;
    }

    input:checked + .slider:before {
      transform: translateX(26px);
    }

    .pump-manual-control {
      opacity: 0.5;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .pump-manual-control.enabled {
      opacity: 1;
      pointer-events: auto;
    }

    /* Alert System */
    .alert-container {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      z-index: 1000;
    }

    .alert {
      padding: 1rem 2rem;
      margin-bottom: 1rem;
      border-radius: 5px;
      color: white;
      animation: slideIn 0.3s ease-out;
    }

    .alert-success { background: var(--primary-color); }
    .alert-warning { background: #f1c40f; }
    .alert-error { background: var(--accent-color); }

    @keyframes slideIn {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .container { padding: 1rem; }

      .header {
        padding: 1rem;
        font-size: 1.3rem;
      }

      .header h1 { font-size: 1.5rem; }
      .logo i { font-size: 1.5rem; }

      .sensor-cards {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        font-size: 1rem;
      }

      .sensor-card {
        padding: 1rem;
        min-height: 180px;
      }

      .sensor-card i {
        font-size: 1.5rem;
        padding-top: 12px;
      }

      .sensor-value { font-size: 1.5rem; }

      .graph-controls {
        flex-direction: column;
        gap: 1rem;
        align-items: stretch;
      }

      .graphs { grid-template-columns: 1fr; }

      .history-controls, .filters {
        flex-direction: column;
        width: 100%;
      }

      .filters input,
      .filters select {
        width: 100%;
      }

      .pagination {
        flex-direction: column;
        align-items: stretch;
      }

      .table-container { overflow-x: auto; }
      table { font-size: 0.9rem; }
      th, td { padding: 0.5rem; }

      .graph-controls h2,
      .config-section h2,
      .history-section h2 {
        font-size: 1.2rem;
      }

      /* Improve table responsiveness */
      .table-container {
        margin: 0 -1rem;
        padding: 0 1rem;
        width: calc(100% + 2rem);
      }

      table {
        min-width: 600px; /* Ensure horizontal scroll on small screens */
      }

      .alert-container {
        bottom: 1rem;
        right: 1rem;
        left: 1rem;
      }

      .alert {
        width: 100%;
        text-align: center;
      }
    }

    @media (max-width: 480px) {
      .header {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
        width: 660px;
      }

      .theme-language {
        width: 100%;
        justify-content: center;
      }

      .sensor-cards,
      .config-grid {
        grid-template-columns: 1fr;
      }

      .config-grid input[type="number"],
      #exportCSV {
        width: 100%;
      }

      .container {
        padding: 0.75rem;
      }

      .header {
        padding: 0.75rem;
      }

      .sensor-card {
        min-height: 150px;
        padding: 0.75rem;
      }

      .sensor-value {
        font-size: 1.25rem;
        margin: 0.5rem 0;
      }

      .status-indicator {
        width: 15px;
        height: 15px;
      }

      /* Adjust form elements */
      button, select, input {
        font-size: 0.9rem;
        padding: 0.4rem 0.8rem;
      }
    }

    @media (max-width: 400px) {
      .header {
        padding: 0.5rem;
        width: 650px;
      }

      .logo i {
        font-size: 1.2rem;
      }

      .header h1 {
        font-size: 1.1rem;
      }

      .theme-language {
        gap: 0.5rem;
      }

      .theme-language select {
        max-width: 100px;
      }

      /* Adjust cards for very small screens */
      .sensor-cards {
        gap: 0.75rem;
      }

      .sensor-card {
        min-height: 130px;
        padding: 0.5rem;
      }

      .sensor-card i {
        font-size: 1.2rem;
        padding-top: 8px;
        margin-bottom: 0.5rem;
      }

      .sensor-card h3 {
        font-size: 0.9rem;
      }

      .sensor-value {
        font-size: 1.1rem;
        margin: 0.3rem 0;
      }

      /* Improve graphs display */
      .graphs-container {
        padding: 0.75rem;
      }

      .graphs canvas {
        max-height: 300px;
      }

      /* Adjust configuration section */
      .config-section,
      .history-section {
        padding: 0.75rem;
      }

      .config-grid {
        gap: 1rem;
      }

      .config-grid label {
        font-size: 0.9rem;
      }

      .config-grid input[type="checkbox"] {
        width: 20px;
        height: 20px;
      }

      /* Improve history controls layout */
      .history-controls {
        gap: 0.5rem;
      }

      .filters {
        gap: 0.4rem;
      }

      .pagination {
        gap: 0.5rem;
      }

      .page-controls {
        gap: 0.3rem;
      }

      .page-controls button {
        padding: 0.2rem 0.4rem;
      }

      /* Adjust water card */
      #waterCard {
        min-height: 130px;
      }

      #waterCard .water-content {
        padding: 0.75rem;
      }

      /* Improve alert display */
      .alert-container {
        bottom: 0.5rem;
        right: 0.5rem;
        left: 0.5rem;
      }

      .alert {
        padding: 0.75rem 1rem;
        font-size: 0.9rem;
      }

      /* Table adjustments */
      .table-container {
        margin: 0 -0.75rem;
        padding: 0 0.75rem;
      }

      th, td {
        padding: 0.4rem;
        font-size: 0.85rem;
      }
    }

    /* Add smooth transitions for better UX */
    .sensor-card,
    .sensor-value,
    button,
    select,
    input {
      transition: var(--transition);
    }

    /* Improve touch targets for mobile */
    @media (hover: none) and (pointer: coarse) {
      button,
      select,
      input[type="checkbox"] {
        min-height: 44px; /* Minimum touch target size */
      }

      .filters select,
      .filters input {
        min-height: 44px;
      }

      .page-controls button {
        min-width: 44px;
      }
    }
  </style>
</head>
<body>
<div class="header">
  <div class="logo">
    <i class="fas fa-leaf"></i>
    <h1>Greenhouse</h1>
  </div>
  <div class="theme-language">
    <button id="themeToggle" class="theme-btn">
      <i class="fas fa-moon"></i>
    </button>
    <select id="languageSelect">
      <option value="en">English</option>
      <option value="bs">Bosanski</option>
    </select>
  </div>
</div>

<div class="container">
  <div class="dashboard">
    <div class="sensor-cards">
      <div class="sensor-card" id="temperatureCard">
        <i class="fas fa-thermometer-half"></i>
        <h3>Temperature</h3>
        <div class="sensor-value">--°C</div>
        <div class="status-indicator"></div>
      </div>
      <div class="sensor-card" id="humidityCard">
        <i class="fas fa-tint"></i>
        <h3>Humidity</h3>
        <div class="sensor-value">--%</div>
        <div class="status-indicator"></div>
      </div>
      <div class="sensor-card" id="soilCard">
        <i class="fas fa-seedling"></i>
        <h3>Soil Moisture</h3>
        <div class="sensor-value">--%</div>
        <div class="status-indicator"></div>
      </div>
      <div class="sensor-card" id="waterCard">
        <div class="water-fill"></div>
        <div class="water-lines"></div>
        <div class="water-content">
          <i class="fas fa-water"></i>
          <h3>Water Level</h3>
          <div class="sensor-value">--%</div>
          <div class="status-indicator"></div>
        </div>
      </div>
    </div>

    <div class="config-section">
      <h2>System Configuration</h2>
      <div class="config-grid">
        <label class="toggle-switch">
          System Status:
          <div class="switch-container">
            <input type="checkbox" id="systemStatus" />
            <span class="slider"></span>
          </div>
        </label>
        <label class="pump-controls">
          Pump Mode:
          <select id="pumpMode">
            <option value="auto">Automatic</option>
            <option value="manual">Manual</option>
          </select>
        </label>
        <label class="pump-manual-control">
          Manual Pump Control:
          <div class="switch-container">
            <input type="checkbox" id="pumpManualControl" disabled />
            <span class="slider"></span>
          </div>
        </label>
        <p></p>
        <br>
        <label>
          Soil Moisture Threshold:
          <input type="number" id="soilThreshold" min="0" max="100" />%
        </label>
        <label>
          Water Level Threshold:
          <input type="number" id="waterThreshold" min="0" max="100" />%
        </label>
        <label>
          Tank Height:
          <input type="number" id="tankHeight" min="0" max="100" />cm
        </label>
        <p></p>
        <br>
        <button id="saveConfig">Save Configuration</button>
      </div>
    </div>

    <div class="graphs-container">
      <div class="graph-controls">
        <h2>Sensor Data Trends</h2>
        <select id="timeframeSelect">
          <option value="1">Last Hour</option>
          <option value="24">Last 24 Hours</option>
          <option value="168">Last Week</option>
        </select>
      </div>
      <div class="graphs">
        <canvas id="tempHumidityChart"></canvas>
        <canvas id="soilWaterChart"></canvas>
      </div>
    </div>

    <div class="history-section">
      <div class="history-header">
        <h2>History Log</h2>
        <div class="history-controls">
          <div class="filters">
            <input type="date" id="dateFilter" />
            <input type="text" id="searchFilter" placeholder="Search..." />
            <select id="valueFilter">
              <option value="all">All Values</option>
              <option value="temperature">Temperature</option>
              <option value="humidity">Humidity</option>
              <option value="soil">Soil Moisture</option>
              <option value="water">Water Level</option>
            </select>
            <select id="rangeFilter">
              <option value="all">All Ranges</option>
              <option value="normal">Normal</option>
              <option value="warning">Warning</option>
              <option value="critical">Critical</option>
            </select>
          </div>
          <div class="pagination">
            <select id="pageSize">
              <option value="10">10 per page</option>
              <option value="25">25 per page</option>
              <option value="50">50 per page</option>
              <option value="100">100 per page</option>
            </select>
            <div class="page-controls">
              <button id="prevPage" disabled><i class="fas fa-chevron-left"></i></button>
              <span id="pageInfo">Page 1 of 1</span>
              <button id="nextPage" disabled><i class="fas fa-chevron-right"></i></button>
            </div>
          </div>
          <button id="exportCSV">
            <i class="fas fa-download"></i> Export to CSV
          </button>
        </div>
      </div>
      <div class="table-container">
        <table id="historyTable">
          <thead>
          <tr>
            <th>Time</th>
            <th>Temperature</th>
            <th>Humidity</th>
            <th>Soil Moisture</th>
            <th>Water Level</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div id="alertContainer" class="alert-container"></div>

<script>
  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyB5eHvhPD2izioqz1uABDReKhJ84FkgQPs",
    authDomain: "esp8266-firebase-demo-6e68a.firebaseapp.com",
    databaseURL: "https://esp8266-firebase-demo-6e68a-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "esp8266-firebase-demo-6e68a",
    storageBucket: "esp8266-firebase-demo-6e68a.appspot.com",
    messagingSenderId: "811931578162",
    appId: "1:811931578162:web:e9576b5b6dddbe5c83712b"
  };

  // Initialize Firebase
  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Theme toggle
  const themeToggle = document.getElementById('themeToggle');
  themeToggle.addEventListener('click', () => {
    const isDark = document.body.dataset.theme === 'dark';
    document.body.dataset.theme = isDark ? 'light' : 'dark';
    themeToggle.innerHTML = `<i class="fas fa-${isDark ? 'sun' : 'moon'}"></i>`;
  });

  // Language translations
  const translations = {
    en: {
      title: "Greenhouse",
      temperature: "Temperature",
      humidity: "Humidity",
      soilMoisture: "Soil Moisture",
      waterLevel: "Water Level",
      systemConfig: "System Configuration",
      historyLog: "History Log",
      export: "Export to CSV",
      sensorTrends: "Sensor Data Trends",
      lastHour: "Last Hour",
      last24Hours: "Last 24 Hours",
      lastWeek: "Last Week",
      systemStatus: "System Status",
      soilThreshold: "Soil Moisture Threshold",
      waterThreshold: "Water Level Threshold",
      tankHeight: "Tank Height",
      saveConfig: "Save Configuration",
      time: "Time",
      configSaved: "Configuration saved successfully",
      configError: "Error saving configuration",
      search: "Search...",
      allValues: "All Values",
      allRanges: "All Ranges",
      normal: "Normal",
      warning: "Warning",
      critical: "Critical",
      perPage: "per page",
      pumpMode: "Pump Mode",
      pumpManual: "Manual",
      pumpAuto: "Automatic",
      manualPumpControl: "Manual Pump Control",
      systemStatusUpdated: "System status updated successfully",
      systemStatusError: "Failed to update system status",
      pumpModeUpdated: "Pump mode updated successfully",
      pumpModeError: "Failed to update pump mode",
      pumpStateUpdated: "Pump state updated successfully",
      pumpStateError: "Failed to update pump state"
    },
    bs: {
      title: "Plastenik",
      temperature: "Temperatura",
      humidity: "Vlažnost",
      soilMoisture: "Vlažnost Tla",
      waterLevel: "Nivo Vode",
      systemConfig: "Konfiguracija Sistema",
      historyLog: "Historija",
      export: "Izvoz u CSV",
      sensorTrends: "Trendovi Podataka Senzora",
      lastHour: "Zadnji Sat",
      last24Hours: "Zadnja 24 Sata",
      lastWeek: "Zadnja Sedmica",
      systemStatus: "Status Sistema",
      soilThreshold: "Prag Vlažnosti Tla",
      waterThreshold: "Prag Nivoa Vode",
      tankHeight: "Visina Rezervoara",
      saveConfig: "Sačuvaj Konfiguraciju",
      time: "Vrijeme",
      configSaved: "Konfiguracija uspješno sačuvana",
      configError: "Greška pri čuvanju konfiguracije",
      search: "Pretraga...",
      allValues: "Sve Vrijednosti",
      allRanges: "Svi Rasponi",
      normal: "Normalno",
      warning: "Upozorenje",
      critical: "Kritično",
      perPage: "po stranici",
      pumpMode: "Način Rada Pumpe",
      pumpManual: "Ručno",
      pumpAuto: "Automatski",
      manualPumpControl: "Ručna Kontrola Pumpe",
      systemStatusUpdated: "Status sistema uspješno ažuriran",
      systemStatusError: "Greška pri ažuriranju statusa sistema",
      pumpModeUpdated: "Način rada pumpe uspješno ažuriran",
      pumpModeError: "Greška pri ažuriranju načina rada pumpe",
      pumpStateUpdated: "Status pumpe uspješno ažuriran",
      pumpStateError: "Greška pri ažuriranju statusa pumpe"
    }
  };

  // System status toggle handler
  document.getElementById('systemStatus').addEventListener('change', function(e) {
    db.ref('system/status').set(e.target.checked)
            .then(() => {
              showAlert('System status updated successfully', 'success');
            })
            .catch(error => {
              showAlert('Failed to update system status: ' + error.message, 'error');
              e.target.checked = !e.target.checked; // Revert the toggle if update fails
            });
  });

  // Pump mode handler
  document.getElementById('pumpMode').addEventListener('change', function(e) {
    const isManual = e.target.value === 'manual';
    const manualControl = document.querySelector('.pump-manual-control');
    const pumpManualControl = document.getElementById('pumpManualControl');

    manualControl.classList.toggle('enabled', isManual);
    pumpManualControl.disabled = !isManual;

    // Create a batch update object
    const updates = {
      'pump/automaticMode': !isManual,
      'pump/manualState': false // Always set manual state to OFF when switching modes
    };

    // Update Firebase
    db.ref().update(updates)
            .then(() => {
              // Update the UI
              pumpManualControl.checked = false;
              showAlert('Pump mode updated successfully', 'success');
            })
            .catch(error => {
              showAlert('Failed to update pump mode: ' + error.message, 'error');
              e.target.value = isManual ? 'manual' : 'auto'; // Revert if update fails
            });
  });

  // Manual pump control handler
  document.getElementById('pumpManualControl').addEventListener('change', function(e) {
    db.ref('pump/manualState').set(e.target.checked)
            .then(() => {
              showAlert('Pump state updated successfully', 'success');
            })
            .catch(error => {
              showAlert('Failed to update pump state: ' + error.message, 'error');
              e.target.checked = !e.target.checked; // Revert if update fails
            });
  });

  // Initialize charts
  const tempHumidityChart = new Chart(
          document.getElementById('tempHumidityChart').getContext('2d'),
          {
            type: 'line',
            data: {
              labels: [],
              datasets: [
                {
                  label: 'Temperature (°C)',
                  borderColor: '#e74c3c',
                  data: []
                },
                {
                  label: 'Humidity (%)',
                  borderColor: '#3498db',
                  data: []
                }
              ]
            },
            options: {
              responsive: true,
              interaction: {
                mode: 'index',
                intersect: false
              },
              plugins: {
                title: {
                  display: true,
                  text: 'Temperature & Humidity'
                }
              }
            }
          }
  );

  const soilWaterChart = new Chart(
          document.getElementById('soilWaterChart').getContext('2d'),
          {
            type: 'line',
            data: {
              labels: [],
              datasets: [
                {
                  label: 'Soil Moisture (%)',
                  borderColor: '#27ae60',
                  data: []
                },
                {
                  label: 'Water Level (%)',
                  borderColor: '#2980b9',
                  data: []
                }
              ]
            },
            options: {
              responsive: true,
              interaction: {
                mode: 'index',
                intersect: false
              },
              plugins: {
                title: {
                  display: true,
                  text: 'Soil Moisture & Water Level'
                }
              }
            }
          }
  );

  // Alert system
  function showAlert(message, type = 'success') {
    const alertContainer = document.getElementById('alertContainer');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.textContent = message;
    alertContainer.appendChild(alert);

    setTimeout(() => {
      alert.style.opacity = '0';
      setTimeout(() => alert.remove(), 300);
    }, 4700);
  }

  // Update sensor displays
  function updateSensorDisplay(data) {
    // Temperature
    const tempCard = document.querySelector('#temperatureCard .sensor-value');
    tempCard.textContent = `${data.temperature_C.toFixed(1)}°C`;
    updateStatusIndicator('#temperatureCard', data.temperature_C, 18, 28);

    // Humidity
    const humCard = document.querySelector('#humidityCard .sensor-value');
    humCard.textContent = `${data.humidity.toFixed(1)}%`;
    updateStatusIndicator('#humidityCard', data.humidity, 40, 70);

    // Soil Moisture
    const soilCard = document.querySelector('#soilCard .sensor-value');
    soilCard.textContent = `${data.soil_moisture.toFixed(1)}%`;
    updateStatusIndicator('#soilCard', data.soil_moisture, 10, 70);

    // Water Level
    const waterCard = document.querySelector('#waterCard .sensor-value');
    const waterFill = document.querySelector('#waterCard .water-fill');
    const waterLevel = data.water_level_percentage;

    waterCard.textContent = `${waterLevel.toFixed(1)}%`;
    waterFill.style.height = `${waterLevel}%`;

    // Update the text color based on the water level
    const waterContent = document.querySelector('#waterCard .water-content');
    waterContent.style.color = waterLevel > 50 ? 'white' : 'var(--text-color)';

    updateStatusIndicator('#waterCard', waterLevel, 20, 80);
  }

  // Update status indicators
  function updateStatusIndicator(cardSelector, value, min, max) {
    const indicator = document.querySelector(`${cardSelector} .status-indicator`);
    if (value < min) {
      indicator.style.backgroundColor = '#e74c3c'; // Red
    } else if (value > max) {
      indicator.style.backgroundColor = '#f1c40f'; // Yellow
    } else {
      indicator.style.backgroundColor = '#2ecc71'; // Green
    }
  }

  // Firebase listeners and initialization
  db.ref('sensor').on('value', (snapshot) => {
    const data = snapshot.val();
    updateSensorDisplay(data);
    updateCharts(data);
  });

  // Load initial configuration
  db.ref('thresholds').on('value', (snapshot) => {
    const thresholds = snapshot.val();
    if (thresholds) {
      document.getElementById('soilThreshold').value = thresholds.soilMoisture;
      document.getElementById('waterThreshold').value = thresholds.waterLevel;
      document.getElementById('tankHeight').value = thresholds.tankHeight;
    }
  });

  db.ref('system/status').on('value', (snapshot) => {
    const systemStatus = snapshot.val();
    document.getElementById('systemStatus').checked = systemStatus;
  });

  db.ref('pump').on('value', (snapshot) => {
    const pumpData = snapshot.val();
    if (pumpData) {
      const isManual = !pumpData.automaticMode;
      document.getElementById('pumpMode').value = isManual ? 'manual' : 'auto';
      document.getElementById('pumpManualControl').checked = isManual && pumpData.manualState;

      const manualControl = document.querySelector('.pump-manual-control');
      manualControl.classList.toggle('enabled', isManual);
      document.getElementById('pumpManualControl').disabled = !isManual;
    }
  });

  // Save configuration
  document.getElementById('saveConfig').addEventListener('click', () => {
    const config = {
      soilMoisture: parseFloat(document.getElementById('soilThreshold').value),
      waterLevel: parseFloat(document.getElementById('waterThreshold').value),
      tankHeight: parseFloat(document.getElementById('tankHeight').value)
    };

    // Update thresholds
    db.ref('thresholds').update({
      soilMoisture: config.soilMoisture,
      waterLevel: config.waterLevel
    })
            .then(() => {
              // Update tank height separately
              return db.ref('thresholds/tankHeight').set(config.tankHeight);
            })
            .then(() => {
              showAlert('Configuration saved successfully', 'success');
            })
            .catch(error => {
              showAlert('Error saving configuration: ' + error.message, 'error');
            });
  });

  // Initialize the page
  document.addEventListener('DOMContentLoaded', () => {
    // Set initial theme
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    document.body.dataset.theme = prefersDark ? 'dark' : 'light';
    themeToggle.innerHTML = `<i class="fas fa-${prefersDark ? 'sun' : 'moon'}"></i>`;
  });

  // Language switching functionality
  function updateLanguage(lang) {
    const currentLang = translations[lang];

    // Update all translatable elements
    const elements = {
      '.header h1': currentLang.title,
      '#temperatureCard h3': currentLang.temperature,
      '#humidityCard h3': currentLang.humidity,
      '#soilCard h3': currentLang.soilMoisture,
      '#waterCard h3': currentLang.waterLevel,
      '.graph-controls h2': currentLang.sensorTrends,
      '.config-section h2': currentLang.systemConfig,
      '.history-section h2': currentLang.historyLog,
      '#exportCSV': currentLang.export
    };

    const configLabels = document.querySelectorAll('.config-grid label');
    configLabels[0].firstChild.textContent = currentLang.systemStatus + ':';
    configLabels[5].firstChild.textContent = currentLang.tankHeight + ':';
    configLabels[4].firstChild.textContent = currentLang.waterThreshold + ':';
    configLabels[3].firstChild.textContent = currentLang.soilThreshold + ':';
    document.getElementById('saveConfig').textContent = currentLang.saveConfig;

    // Update timeframe select options
    const timeframeSelect = document.getElementById('timeframeSelect');
    timeframeSelect.options[0].text = currentLang.lastHour;
    timeframeSelect.options[1].text = currentLang.last24Hours;
    timeframeSelect.options[2].text = currentLang.lastWeek;

    // Update table headers
    const tableHeaders = document.querySelectorAll('#historyTable th');
    tableHeaders[0].textContent = currentLang.time;
    tableHeaders[1].textContent = currentLang.temperature;
    tableHeaders[2].textContent = currentLang.humidity;
    tableHeaders[3].textContent = currentLang.soilMoisture;
    tableHeaders[4].textContent = currentLang.waterLevel;

    // Update all other elements
    for (const [selector, text] of Object.entries(elements)) {
      const element = document.querySelector(selector);
      if (element) element.textContent = text;
    }

    // Update chart titles
    tempHumidityChart.options.plugins.title.text =
            `${currentLang.temperature} & ${currentLang.humidity}`;
    soilWaterChart.options.plugins.title.text =
            `${currentLang.soilMoisture} & ${currentLang.waterLevel}`;

    // Update filter placeholders and options
    document.getElementById('searchFilter').placeholder = currentLang.search;

    const valueFilter = document.getElementById('valueFilter');
    valueFilter.options[0].text = currentLang.allValues;
    valueFilter.options[1].text = currentLang.temperature;
    valueFilter.options[2].text = currentLang.humidity;
    valueFilter.options[3].text = currentLang.soilMoisture;
    valueFilter.options[4].text = currentLang.waterLevel;

    const rangeFilter = document.getElementById('rangeFilter');
    rangeFilter.options[0].text = currentLang.allRanges;
    rangeFilter.options[1].text = currentLang.normal;
    rangeFilter.options[2].text = currentLang.warning;
    rangeFilter.options[3].text = currentLang.critical;

    // Update pagination text
    document.querySelectorAll('#pageSize option').forEach(option => {
      option.text = `${option.value} ${currentLang.perPage}`;
    });

    // Update pump controls
    const pumpModeLabel = document.querySelector('.pump-controls');
    pumpModeLabel.firstChild.textContent = currentLang.pumpMode + ':';

    const pumpModeSelect = document.getElementById('pumpMode');
    pumpModeSelect.options[0].text = currentLang.pumpAuto;
    pumpModeSelect.options[1].text = currentLang.pumpManual;

    const manualPumpLabel = document.querySelector('.pump-manual-control');
    manualPumpLabel.firstChild.textContent = currentLang.manualPumpControl + ':';

    // Update alert messages in event listeners
    document.getElementById('systemStatus').addEventListener('change', function(e) {
      db.ref('system/status').set(e.target.checked)
              .then(() => {
                showAlert(currentLang.systemStatusUpdated, 'success');
              })
              .catch(error => {
                showAlert(currentLang.systemStatusError + ': ' + error.message, 'error');
                e.target.checked = !e.target.checked;
              });
    });

    tempHumidityChart.update();
    soilWaterChart.update();
  }

  document.getElementById('languageSelect').addEventListener('change', (e) => {
    updateLanguage(e.target.value);
  });

  // Chart update functionality
  function updateCharts() {
    const timeframe = parseInt(document.getElementById('timeframeSelect').value);
    const currentTime = Math.floor(Date.now() / 1000);
    const cutoffTime = currentTime - (timeframe * 60 * 60);

    db.ref('history').once('value', (snapshot) => {
      const historyData = [];
      snapshot.forEach((childSnapshot) => {
        const data = childSnapshot.val();
        if (data.timestamp && data.temperature_C !== undefined) {
          historyData.push({
            timestamp: parseInt(data.timestamp),
            temperature: data.temperature_C,
            humidity: data.humidity,
            soil_moisture: data.soil_moisture,
            water_level: data.water_level_percentage
          });
        }
      });

      // Sort data by timestamp
      historyData.sort((a, b) => a.timestamp - b.timestamp);

      // Filter data for selected timeframe
      const filteredData = historyData.filter(data => data.timestamp >= cutoffTime);

      // Update charts with local time
      const labels = filteredData.map(data => {
        const date = new Date(data.timestamp * 1000);
        return date.toLocaleTimeString();
      });

      // Update Temperature & Humidity Chart
      tempHumidityChart.data.labels = labels;
      tempHumidityChart.data.datasets[0].data = filteredData.map(data => data.temperature);
      tempHumidityChart.data.datasets[1].data = filteredData.map(data => data.humidity);
      tempHumidityChart.update();

      // Update Soil & Water Chart
      soilWaterChart.data.labels = labels;
      soilWaterChart.data.datasets[0].data = filteredData.map(data => data.soil_moisture);
      soilWaterChart.data.datasets[1].data = filteredData.map(data => data.water_level);
      soilWaterChart.update();

      // Update history table
      updateHistoryTable(filteredData);
    });
  }

  let currentPage = 1;
  let filteredData = [];

  // History table update
  function updateHistoryTable(historyData) {
    // Store the full dataset
    filteredData = [...historyData];

    // Apply filters
    const dateFilter = document.getElementById('dateFilter').value;
    const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
    const valueFilter = document.getElementById('valueFilter').value;
    const rangeFilter = document.getElementById('rangeFilter').value;

    filteredData = filteredData.filter(data => {
      const date = new Date(data.timestamp * 1000);
      const dateString = date.toISOString().split('T')[0];

      // Date filter
      if (dateFilter && dateString !== dateFilter) return false;

      // Search filter
      if (searchFilter) {
        const searchString = `${date.toLocaleString()} ${data.temperature} ${data.humidity} ${data.soil_moisture} ${data.water_level}`.toLowerCase();
        if (!searchString.includes(searchFilter)) return false;
      }

      // Value filter
      if (valueFilter !== 'all') {
        const valueMap = {
          temperature: 'temperature',
          humidity: 'humidity',
          soil: 'soil_moisture',
          water: 'water_level'
        };

        const value = data[valueMap[valueFilter]];

        if (rangeFilter !== 'all') {
          const ranges = {
            temperature: {
              normal: { min: 18, max: 28 },
              warning: [
                { min: 15, max: 18 },
                { min: 28, max: 30 }
              ],
              critical: [
                { min: -Infinity, max: 15 },
                { min: 30, max: Infinity }
              ]
            },
            humidity: {
              normal: { min: 40, max: 70 },
              warning: [
                { min: 30, max: 40 },
                { min: 70, max: 80 }
              ],
              critical: [
                { min: -Infinity, max: 30 },
                { min: 80, max: Infinity }
              ]
            },
            soil: {
              normal: { min: 30, max: 70 },
              warning: [
                { min: 20, max: 30 },
                { min: 70, max: 80 }
              ],
              critical: [
                { min: -Infinity, max: 20 },
                { min: 80, max: Infinity }
              ]
            },
            water: {
              normal: { min: 50, max: 80 },
              warning: [
                { min: 30, max: 50 },
                { min: 80, max: 90 }
              ],
              critical: [
                { min: -Infinity, max: 30 },
                { min: 90, max: Infinity }
              ]
            }
          };

          const rangeSet = ranges[valueFilter][rangeFilter];

          // Check if value is in range
          if (Array.isArray(rangeSet)) {
            // Multiple ranges (warning and critical)
            const inRange = rangeSet.some(range =>
                    value >= range.min && value < range.max
            );
            if (!inRange) return false;
          } else {
            // Single range (normal)
            if (value < rangeSet.min || value > rangeSet.max) return false;
          }
        }
      }

      return true;
    });

    // Sort filtered data
    filteredData.sort((a, b) => b.timestamp - a.timestamp);

    // Update pagination
    const pageSize = parseInt(document.getElementById('pageSize').value);
    const totalPages = Math.max(1, Math.ceil(filteredData.length / pageSize));
    currentPage = Math.min(currentPage, totalPages);

    document.getElementById('prevPage').disabled = currentPage === 1;
    document.getElementById('nextPage').disabled = currentPage === totalPages;
    document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;

    // Display current page
    const startIndex = (currentPage - 1) * pageSize;
    const pageData = filteredData.slice(startIndex, startIndex + pageSize);

    // Update table
    const tbody = document.querySelector('#historyTable tbody');
    tbody.innerHTML = '';

    if (pageData.length === 0) {
      const emptyRow = document.createElement('tr');
      emptyRow.innerHTML = `
            <td colspan="5" style="text-align: center; padding: 2rem;">
                No data available for the selected filters
            </td>
        `;
      tbody.appendChild(emptyRow);
    } else {
      pageData.forEach(data => {
        const date = new Date(data.timestamp * 1000);
        const row = document.createElement('tr');
        row.innerHTML = `
                <td>${date.toLocaleString()}</td>
                <td>${data.temperature.toFixed(1)}°C</td>
                <td>${data.humidity.toFixed(1)}%</td>
                <td>${data.soil_moisture.toFixed(1)}%</td>
                <td>${data.water_level.toFixed(1)}%</td>
            `;
        tbody.appendChild(row);
      });
    }
  }

  // Add event listeners for filters and pagination
  document.getElementById('dateFilter').addEventListener('change', () => {
    currentPage = 1;
    updateCharts();
  });

  document.getElementById('searchFilter').addEventListener('input', () => {
    currentPage = 1;
    updateCharts();
  });

  document.getElementById('valueFilter').addEventListener('change', () => {
    currentPage = 1;
    updateCharts();
  });

  document.getElementById('rangeFilter').addEventListener('change', () => {
    currentPage = 1;
    updateCharts();
  });

  document.getElementById('pageSize').addEventListener('change', () => {
    currentPage = 1;
    updateCharts();
  });

  document.getElementById('prevPage').addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      updateHistoryTable(filteredData);
    }
  });

  document.getElementById('nextPage').addEventListener('click', () => {
    const pageSize = parseInt(document.getElementById('pageSize').value);
    const totalPages = Math.ceil(filteredData.length / pageSize);
    if (currentPage < totalPages) {
      currentPage++;
      updateHistoryTable(filteredData);
    }
  });

  // Add event listeners
  document.getElementById('timeframeSelect').addEventListener('change', updateCharts);

  // Initialize charts when page loads
  document.addEventListener('DOMContentLoaded', () => {
    updateCharts();
  });

  // Update charts when new data arrives
  db.ref('sensor').on('value', () => {
    updateCharts();
  });

  // CSV Export functionality
  document.getElementById('exportCSV').addEventListener('click', () => {
    db.ref('history').once('value', (snapshot) => {
      const data = [];

      snapshot.forEach((childSnapshot) => {
        const record = childSnapshot.val();
        // Check if record has all required properties
        if (record && record.timestamp &&
                record.temperature_C !== undefined &&
                record.humidity !== undefined &&
                record.soil_moisture !== undefined &&
                record.water_level_percentage !== undefined) {

          const date = new Date(parseInt(record.timestamp) * 1000);

          data.push({
            timestamp: date.toLocaleString(),
            temperature: record.temperature_C,
            humidity: record.humidity,
            soil_moisture: record.soil_moisture,
            water_level: record.water_level_percentage
          });
        }
      });

      if (data.length === 0) {
        showAlert('No valid data to export', 'error');
        return;
      }

      // Sort data by timestamp
      data.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

      // Create CSV content
      const headers = ['Time', 'Temperature (°C)', 'Humidity (%)', 'Soil Moisture (%)', 'Water Level (%)'];
      const csvRows = [
        headers.join(','),
        ...data.map(row => [
          `"${row.timestamp}"`,
          row.temperature.toFixed(1),
          row.humidity.toFixed(1),
          row.soil_moisture.toFixed(1),
          row.water_level.toFixed(1)
        ].join(','))
      ];

      const csvContent = csvRows.join('\n');

      // Create and trigger download
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', `greenhouse_data_${new Date().toISOString().split('T')[0]}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      window.URL.revokeObjectURL(url);

      showAlert('Data exported successfully', 'success');
    });
  });
</script>
</body>
</html>